# ä½¿ç”¨ Claude Code ä¸æˆ‘ä»¬çš„æ•°æ®é›†çš„ç®€å•ç¤ºä¾‹

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ **Claude Code** å¯¹ AACR-Bench æ•°æ®é›†ä¸­çš„ GitHub Pull Requests è¿›è¡Œè‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥çš„ç¤ºä¾‹ç¨‹åºã€‚

## ğŸ“‹ æ¦‚è¿°

æœ¬ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•é€šè¿‡ Claude Code API å¯¹çœŸå®å¼€æºé¡¹ç›®çš„ PR è¿›è¡Œä»£ç å®¡æŸ¥ã€‚ä¸»è¦åŠŸèƒ½åŒ…æ‹¬:

- è‡ªåŠ¨å…‹éš†å¹¶åˆ‡æ¢åˆ°ç›®æ ‡ PR åˆ†æ”¯
- é…ç½®ä»£ç å®¡æŸ¥ Agent
- æ‰§è¡Œä»£ç å˜æ›´çš„è‡ªåŠ¨å®¡æŸ¥
- æ”¶é›†å¹¶ä¿å­˜å®¡æŸ¥è¯„è®º

æ­¤ç¤ºä¾‹ä»…ä¾›å‚è€ƒ,å±•ç¤ºå¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„æ•°æ®é›†ã€‚è¯·ä½¿ç”¨æ‚¨è‡ªå·±çš„ä»£ç å®¡æŸ¥ agent è¿›è¡Œå®é™…è¯„ä¼°ã€‚

## ğŸ“ ç»“æ„

```
claude-code-demo/
â”œâ”€â”€ main.py                  # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ config.json          # é…ç½®æ–‡ä»¶(Claude CLI è·¯å¾„ã€æ•°æ®é›†è·¯å¾„)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ claude_code_util.py  # Claude Code å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ git_util.py          # Git æ“ä½œå·¥å…·
â”‚   â”œâ”€â”€ dataset_util.py      # æ•°æ®é›†åŠ è½½å’Œè§£æ
â”‚   â”œâ”€â”€ constants_util.py    # å¸¸é‡å®šä¹‰(prompt æ¨¡æ¿ç­‰)
â”‚   â””â”€â”€ model.py             # æ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ .claude/
â”‚   â””â”€â”€ agents/
â”‚       â””â”€â”€ code-reviewer.md # ä»£ç å®¡æŸ¥ Agent é…ç½®
â”œâ”€â”€ comments/                # å®¡æŸ¥ç»“æœå­˜å‚¨ç›®å½•
â”œâ”€â”€ README.md                # è‹±æ–‡ README
â””â”€â”€ README.zh-CN.md          # ä¸­æ–‡ README
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. main.py - ä¸»ç¨‹åº
- `load_data_as_task()`: å°†åŸå§‹æ•°æ®é›†è½¬æ¢ä¸ºä»»åŠ¡æ ¼å¼
- `run_claude_code()`: å¯¹å•ä¸ª PR æ‰§è¡Œå®Œæ•´çš„å®¡æŸ¥æµç¨‹
- `main()`: ä¸»å¾ªç¯,æ‰¹é‡å¤„ç†æ‰€æœ‰ PR å¹¶è·Ÿè¸ªè¿›åº¦
- `copy_comments()`: æå–å¹¶ä¿å­˜ Claude Code ç”Ÿæˆçš„è¯„è®º

### 2. utils/ å·¥å…·æ¨¡å—

#### claude_code_util.py
- `get_claude_code_options()`: é…ç½® Claude Code è¿è¡Œå‚æ•°
- `add_code_review_agent()`: åˆ›å»ºä»£ç å®¡æŸ¥ Agent
- `load_config()`: åŠ è½½é…ç½®æ–‡ä»¶

#### git_util.py
- `git_clone()`: å°† Git ä»“åº“å…‹éš†åˆ°æœ¬åœ°
- `checkout()`: åˆ‡æ¢åˆ°æŒ‡å®šçš„ PR åˆ†æ”¯
- `git_fetch()`: è·å–æŒ‡å®šçš„ commit

#### dataset_util.py
- `load_dataset()`: ä» JSON æ–‡ä»¶åŠ è½½æ•°æ®é›†
- `get_gitrepo_pr_id()`: ä» PR URL è§£æä»“åº“å’Œ PR ID

#### constants_util.py
- `BASE_PROMPT`: ä»£ç å®¡æŸ¥ prompt æ¨¡æ¿

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹ä¾èµ–:
```bash
pip install claude-agent-sdk anyio tqdm
```

### 2. é…ç½® Claude CLI

ç¼–è¾‘ `configs/config.json` å¹¶è®¾ç½® Claude CLI çš„å®‰è£…è·¯å¾„:

```json
{
  "cli_path": "C:\\Users\\YourName\\AppData\\Roaming\\npm\\claude.cmd",
  "data_path": "C:\\path\\to\\your\\dataset\\positive_samples.json"
}
```

### 3. å‡†å¤‡æ•°æ®é›†

é¦–æ¬¡è¿è¡Œæ—¶,éœ€è¦å°†åŸå§‹æ•°æ®è½¬æ¢ä¸ºä»»åŠ¡æ ¼å¼ã€‚åœ¨ `main.py` ä¸­å–æ¶ˆæ³¨é‡Šå¹¶è¿è¡Œ:

```python
if __name__ == "__main__":
    load_data_as_task()  # é¦–æ¬¡è¿è¡Œ:ç”Ÿæˆä»»åŠ¡æ–‡ä»¶
    # main()              # æ­£å¼è¿è¡Œ:æ‰§è¡Œå®¡æŸ¥ä»»åŠ¡
```

è¿™å°†:
- è¯»å–åŸå§‹æ•°æ®é›†(ç”± `data_path` æŒ‡å®š)
- ä¸ºæ¯ä¸ª PR æ·»åŠ  `finish` æ ‡å¿—ä»¥è·Ÿè¸ªè¿›åº¦
- ç”Ÿæˆ `tmp_data.json` ä»»åŠ¡æ–‡ä»¶

### 4. è¿è¡Œä»£ç å®¡æŸ¥

```bash
cd claude-code-demo
python main.py
```

ç¨‹åºå°†è‡ªåŠ¨:
1. åŠ è½½ä»»åŠ¡æ•°æ®é›†
2. é€ä¸ªå¤„ç†æ¯ä¸ª PR(è·³è¿‡å·²å®Œæˆçš„)
3. å…‹éš†ä»“åº“å¹¶åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
4. è°ƒç”¨ Claude Code è¿›è¡Œä»£ç å®¡æŸ¥
5. å°†å®¡æŸ¥è¯„è®ºä¿å­˜åˆ° `comments/` ç›®å½•
6. æ¯ä¸ªä»»åŠ¡å®Œæˆåç­‰å¾… 30 ç§’(é¿å…ç½‘ç»œé™åˆ¶)
7. å®æ—¶ä¿å­˜è¿›åº¦åˆ° `tmp_data.json`

## ğŸ“Š æ•°æ®æ ¼å¼

### è¾“å…¥æ•°æ®é›†æ ¼å¼

```json
{
  "githubPrUrl": "https://github.com/owner/repo/pull/123",
  "source_commit": "abc123...",
  "target_commit": "def456...",
  "change_line_count": 100,
  "project_main_language": "Python",
  "finish": false
}
```

### å­—æ®µè¯´æ˜
- `githubPrUrl`: GitHub Pull Request çš„å®Œæ•´ URL
- `source_commit`: PR çš„æº commit å“ˆå¸Œ
- `target_commit`: PR çš„ç›®æ ‡ commit å“ˆå¸Œ
- `change_line_count`: å˜æ›´çš„ä»£ç è¡Œæ•°
- `project_main_language`: é¡¹ç›®çš„ä¸»è¦ç¼–ç¨‹è¯­è¨€
- `finish`: ä»»åŠ¡å®Œæˆæ ‡å¿—(ç”±ç¨‹åºè‡ªåŠ¨ç»´æŠ¤)

### å®¡æŸ¥ç»“æœæ ¼å¼

å®¡æŸ¥ç»“æœä¿å­˜åœ¨ `comments/` ç›®å½•ä¸­,å‘½åæ ¼å¼ä¸º:
```
comments_{repo_name}_{pr_id}.txt
```

ä¾‹å¦‚: `comments_FreeCAD_18688.txt`

æ–‡ä»¶å†…å®¹åŒ…å« Claude Code ç”Ÿæˆçš„ä»£ç å®¡æŸ¥è¯„è®º,åŒ…æ‹¬:
- é—®é¢˜å‘ç°
- æ”¹è¿›å»ºè®®
- ä»£ç è´¨é‡è¯„ä¼°

## ğŸ”„ å·¥ä½œæµç¨‹

```
1. åŠ è½½æ•°æ®é›†(tmp_data.json)
   â†“
2. å…‹éš†ä»“åº“åˆ°æœ¬åœ°(repos/ ç›®å½•)
   â†“
3. åˆ‡æ¢åˆ° PR åˆ†æ”¯
   â†“
4. è·å–æº commit å’Œç›®æ ‡ commit
   â†“
5. åˆ›å»ºä»£ç å®¡æŸ¥ Agent
   â†“
6. è°ƒç”¨ Claude Code å®¡æŸ¥ä»£ç å˜æ›´
   â†“
7. æå–å®¡æŸ¥è¯„è®º
   â†“
8. ä¿å­˜åˆ° comments/ ç›®å½•
   â†“
9. æ ‡è®°ä»»åŠ¡ä¸ºå·²å®Œæˆ
   â†“
10. ç»§ç»­ä¸‹ä¸€ä¸ª PR
   â†“
11. è·å–è¯„è®º
   â†“
12. å¼€å§‹è¯„ä¼°(evaluator_runner/example_test.py)
```

## âš™ï¸ é…ç½®è¯´æ˜

### Claude Code Agent

`.claude/agents/code-reviewer.md` å®šä¹‰äº†ä»£ç å®¡æŸ¥çš„è¡Œä¸ºå’Œè§„åˆ™,åŒ…æ‹¬:
- å®¡æŸ¥é‡ç‚¹(å®‰å…¨æ€§ã€æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ç­‰)
- è¾“å‡ºæ ¼å¼è¦æ±‚
- ä¸Šä¸‹æ–‡ä½¿ç”¨ç­–ç•¥

### Prompt æ¨¡æ¿

`utils/constants_util.py` ä¸­çš„ `BASE_PROMPT` å®šä¹‰äº†å‘é€ç»™ Claude Code çš„ prompt

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œé™åˆ¶**: ç¨‹åºåœ¨å®Œæˆæ¯ä¸ªä»»åŠ¡åä¼šç­‰å¾… 30 ç§’,ä»¥é¿å…è§¦å‘ API é™åˆ¶
2. **è¿›åº¦æ¢å¤**: ç¨‹åºä¼šè‡ªåŠ¨è·³è¿‡æ ‡è®°ä¸º `finish: true` çš„ä»»åŠ¡,æ”¯æŒä¸­æ–­åç»§ç»­æ‰§è¡Œ
3. **ç£ç›˜ç©ºé—´**: å…‹éš†çš„ä»“åº“å°†ä¿å­˜åœ¨ `repos/` ç›®å½•ä¸­,è¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
4. **Claude CLI**: ç¡®ä¿ Claude CLI å·²æ­£ç¡®å®‰è£…å¹¶é…ç½®äº†æœ‰æ•ˆçš„ API key

## ğŸ“š æ‰©å±•ä½¿ç”¨

### è‡ªå®šä¹‰å®¡æŸ¥è§„åˆ™
ç¼–è¾‘ `.claude/agents/code-reviewer.md` ä»¥è‡ªå®šä¹‰å®¡æŸ¥é‡ç‚¹å’Œè¾“å‡ºæ ¼å¼ã€‚

### æ‰¹é‡å¤„ç†
ä¿®æ”¹ `main.py` ä¸­çš„å¾ªç¯é€»è¾‘,æ·»åŠ å¹¶è¡Œå¤„ç†ã€è¿‡æ»¤ç‰¹å®šè¯­è¨€ç­‰åŠŸèƒ½ã€‚

### ç»“æœåˆ†æ
ä½¿ç”¨ `comments/` ç›®å½•ä¸­çš„ç»“æœæ–‡ä»¶è¿›è¡Œè¿›ä¸€æ­¥çš„ç»Ÿè®¡åˆ†æå’Œæ¨¡å‹è¯„ä¼°ã€‚
